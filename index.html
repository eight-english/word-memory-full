<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Word Memory App</title>
  <style>
    body{font-family:sans-serif;padding:1rem;max-width:480px;margin:auto}
    h1{text-align:center;font-size:1.5rem;margin-bottom:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:1rem;align-items:center}
    input[type="text"]{flex:1;min-width:150px;padding:6px;font-size:1rem}
    button{font-size:1rem;padding:6px 12px}
    .pagination{margin:1rem 0;text-align:center}
    .pagination a{margin:0 5px;text-decoration:none}
    .card{border:1px solid #ccc;border-radius:10px;padding:1rem;margin:1rem 0;display:flex;flex-direction:column;gap:.5rem}
    .card img{width:100%;height:auto;border-radius:8px}
  </style>
</head>
<body>
  <h1>Word Memory App</h1>

  <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šï¼‰ -->
  <div class="pagination" id="paginationTop"></div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="controls">
    <input id="searchInput" placeholder="å˜èªæ¤œç´¢..." oninput="filterCards()">
    <button onclick="playUnlearned()">â–¶ï¸ è¦šãˆã¦ã„ãªã„ã‚«ãƒ¼ãƒ‰ã ã‘å†ç”Ÿ</button>
    <button onclick="resetLearned()">ğŸ”„ è¦šãˆãŸçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <div id="cards"></div>

  <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ï¼‰ -->
  <div class="pagination" id="paginationBottom"></div>

  <script src="wordmap.js"></script>
  <script>
    /* -------- åŸºæœ¬è¨­å®š -------- */
    const pageSize   = 20;
    const totalItems = 721;
    const totalPages = Math.ceil(totalItems / pageSize);
    const urlParams  = new URLSearchParams(window.location.search);
    const page       = urlParams.has("page") ? parseInt(urlParams.get("page")) : 0;   // 0 = TOP
    const start      = page > 0 ? (page - 1) * pageSize + 1 : 1;
    const end        = page > 0 ? Math.min(start + pageSize - 1, totalItems) : totalItems;
    const showImages = page > 0;

    /* -------- å­¦ç¿’çŠ¶æ…‹ -------- */
    const keyOf     = i => "learned_" + i;
    const isLearned = i => localStorage.getItem(keyOf(i)) === "1";
    function toggleLearned(i, cb){ localStorage.setItem(keyOf(i), cb.checked ? "1" : "0"); }

    /* -------- Audio ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -------- */
    let player = null;               // å†åˆ©ç”¨ã™ã‚‹å˜ä¸€ Audio ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    function singlePlay(src){
      if(!player){ player = new Audio(); }
      player.src = src;
      player.currentTime = 0;
      player.play().catch(()=>{});   // iOS Safari ã® Promise ä¾‹å¤–å›é¿
    }

    /* -------- æœªå­¦ç¿’ã‚«ãƒ¼ãƒ‰ã® src ãƒªã‚¹ãƒˆ -------- */
    const audioSrcList = [];

    /* -------- ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ -------- */
    function loadCards(){
      const wrap = document.getElementById("cards");
      for(let i = start; i <= end; i++){
        const id   = i.toString().padStart(3,"0");
        const word = (typeof wordmap!=='undefined' && wordmap[id]) ? wordmap[id] : "";
        const src  = `assets/${id}_${word}.mp3`;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          ${ showImages ? `<img src="assets/File${i}.png" alt="Image ${i}">` : "" }
          <p><strong>${id}</strong> â€” ${word}</p>
          <button onclick="singlePlay('${src}')">â–¶ï¸ å†ç”Ÿã™ã‚‹</button>
          <label><input type="checkbox" onchange="toggleLearned(${i},this)" ${isLearned(i)?"checked":""}> è¦šãˆãŸ</label>`;
        wrap.appendChild(card);

        if(!isLearned(i)) audioSrcList.push(src);
      }
    }

    /* -------- æœªå­¦ç¿’ã‚«ãƒ¼ãƒ‰ã‚’é€£ç¶šå†ç”Ÿ -------- */
    function playUnlearned(){
      let idx = 0;
      const next = ()=>{
        if(idx >= audioSrcList.length) return;
        singlePlay(audioSrcList[idx]);
        player.onended = ()=>{ idx++; next(); };
      };
      next();
    }

    /* -------- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ -------- */
    function filterCards(){
      const kw = document.getElementById("searchInput").value.toLowerCase();
      document.querySelectorAll(".card").forEach(c=>{
        c.style.display = c.textContent.toLowerCase().includes(kw) ? "block" : "none";
      });
    }

    /* -------- è¦šãˆãŸãƒªã‚»ãƒƒãƒˆ -------- */
    function resetLearned(){
      for(let i=1;i<=totalItems;i++) localStorage.removeItem(keyOf(i));
      location.reload();
    }

    /* -------- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -------- */
    function buildPager(target){
      const top = document.createElement("a");
      top.href="index.html"; top.textContent="[TOP]";
      target.appendChild(top);
      for(let p=1;p<=totalPages;p++){
        const a=document.createElement("a");
        a.href=`?page=${p}`; a.textContent=`[${p}]`;
        if(p===page) a.style.fontWeight="bold";
        target.appendChild(a);
      }
    }

    /* -------- åˆæœŸåŒ– -------- */
    buildPager(document.getElementById("paginationTop"));
    buildPager(document.getElementById("paginationBottom"));
    loadCards();
  </script>
</body>
</html>
